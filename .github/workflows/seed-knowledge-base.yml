# ============================================
# Knowledge Base Seeder - Automated Workflow
# ============================================
# 
# This workflow runs the knowledge base seeder on a schedule to keep
# the VentureXify RAG system up to date with fresh content.
#
# Schedule: Weekly (every Monday at 6 AM UTC)
# Can also be triggered manually via workflow_dispatch
#
# Scraping Method: Playwright headless browser (no Reddit API keys needed!)
# The stealth plugin makes scraping invisible to bot detection.
#
# Required Secrets:
# - SUPABASE_URL: Your Supabase project URL
# - SUPABASE_SERVICE_ROLE_KEY: Service role key for upserts
# - HF_API_KEY: HuggingFace API key for embeddings
#
#

name: Seed Knowledge Base

on:
  # Run weekly: Every Monday at 6 AM UTC
  schedule:
    - cron: '0 6 * * 1'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      use_playwright:
        description: 'Use Playwright headless browser for Reddit (recommended)'
        required: false
        default: true
        type: boolean
      include_reddit:
        description: 'Include Reddit scraping'
        required: false
        default: true
        type: boolean
      include_capitalone:
        description: 'Include Capital One scraping'
        required: false
        default: true
        type: boolean
      max_posts:
        description: 'Max Reddit posts to scrape'
        required: false
        default: '50'
        type: string

jobs:
  seed:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Playwright scraping takes longer
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: venture-x-os/package-lock.json
      
      - name: Install dependencies
        working-directory: venture-x-os
        run: npm ci
      
      - name: Install Playwright Chromium
        if: ${{ github.event.inputs.use_playwright != 'false' }}
        working-directory: venture-x-os
        run: npx playwright install chromium --with-deps
      
      - name: Run knowledge base seeder (Playwright)
        working-directory: venture-x-os
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
          USE_PLAYWRIGHT: ${{ github.event.inputs.use_playwright || 'true' }}
          PLAYWRIGHT_HEADLESS: 'true'
          INCLUDE_REDDIT: ${{ github.event.inputs.include_reddit || 'true' }}
          MAX_POSTS: ${{ github.event.inputs.max_posts || '50' }}
          MAX_REDDIT_PAGES: '5'
          INCLUDE_CAPITALONE: ${{ github.event.inputs.include_capitalone || 'true' }}
          # Fallback: Reddit OAuth (only used if Playwright fails)
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        run: npm run seed
      
      - name: Report status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Knowledge base seeding completed successfully!"
            echo "   Method: Playwright headless browser"
            echo "   Time: $(date -u)"
          else
            echo "❌ Knowledge base seeding failed. Check logs above."
          fi

  # Separate job for notifications (optional)
  notify-on-failure:
    needs: seed
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Create GitHub Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `⚠️ Knowledge Base Seeder Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Knowledge Base Seeder Failed
            
            **Workflow Run:** [View Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Time:** ${new Date().toISOString()}
            **Method:** Playwright headless browser
            
            ### Possible Causes:
            - Supabase credentials expired or invalid
            - HuggingFace API rate limited
            - Reddit changed their page structure (update CSS selectors in \`scripts/playwright-config.cjs\`)
            - Playwright browser install failed in CI
            - Capital One website structure changed
            
            ### Action Required:
            1. Check the workflow logs for specific errors
            2. Verify secrets are still valid (\`SUPABASE_URL\`, \`SUPABASE_SERVICE_ROLE_KEY\`, \`HF_API_KEY\`)
            3. If Reddit selectors broke, update \`scripts/playwright-config.cjs\` SELECTORS
            4. Run manually to test fixes: Actions → Seed Knowledge Base → Run workflow
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'automation']
            });
