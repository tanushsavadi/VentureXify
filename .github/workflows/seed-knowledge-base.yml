# ============================================
# Knowledge Base Seeder - Automated Workflow
# ============================================
# 
# This workflow runs the knowledge base seeder on a schedule to keep
# the VentureXify RAG system up to date with fresh content.
#
# Schedule: Every 2 weeks (1st and 15th of each month at 6 AM UTC)
# Can also be triggered manually via workflow_dispatch
#
# Required Secrets:
# - SUPABASE_URL: Your Supabase project URL
# - SUPABASE_SERVICE_ROLE_KEY: Service role key for upserts
# - HF_API_KEY: HuggingFace API key for embeddings
# - REDDIT_CLIENT_ID: (Optional) Reddit OAuth client ID
# - REDDIT_CLIENT_SECRET: (Optional) Reddit OAuth client secret
#

name: Seed Knowledge Base

on:
  # Run bi-weekly: 1st and 15th of each month at 6 AM UTC
  schedule:
    - cron: '0 6 1,15 * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      include_reddit:
        description: 'Include Reddit scraping (requires OAuth)'
        required: false
        default: true
        type: boolean
      max_posts:
        description: 'Max Reddit posts to scrape'
        required: false
        default: '50'
        type: string

jobs:
  seed:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: venture-x-os/package-lock.json
      
      - name: Install dependencies
        working-directory: venture-x-os
        run: npm ci
      
      - name: Run knowledge base seeder
        working-directory: venture-x-os
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          INCLUDE_REDDIT: ${{ github.event.inputs.include_reddit || 'true' }}
          MAX_POSTS: ${{ github.event.inputs.max_posts || '50' }}
          INCLUDE_CAPITALONE: 'true'
        run: npm run seed
      
      - name: Report status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Knowledge base seeding completed successfully!"
          else
            echo "❌ Knowledge base seeding failed. Check logs above."
          fi

  # Separate job for notifications (optional)
  notify-on-failure:
    needs: seed
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Create GitHub Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `⚠️ Knowledge Base Seeder Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Knowledge Base Seeder Failed
            
            **Workflow Run:** [View Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Time:** ${new Date().toISOString()}
            
            ### Possible Causes:
            - Supabase credentials expired or invalid
            - HuggingFace API rate limited
            - Capital One website structure changed
            - Reddit API blocked (needs OAuth credentials)
            
            ### Action Required:
            1. Check the workflow logs for specific errors
            2. Verify secrets are still valid
            3. Run manually to test fixes
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'automation']
            });
